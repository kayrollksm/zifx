<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard â€” ZIFX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>body{font-family:Poppins,sans-serif}</style>
</head>

<body class="bg-[#0D1A1E] text-white">

<div class="flex min-h-screen">

  <!-- SIDEBAR -->
  <div id="sidebar"></div>

  <!-- MAIN -->
  <div class="ml-64 flex-1">
    <header class="border-b border-white/5 px-6 h-14 flex items-center justify-between">
      <span class="font-semibold">Dashboard</span>
      <span id="userName" class="text-sm text-[#7D8895]">User</span>
    </header>

    <main class="px-6 py-8 space-y-8">

      <div class="grid md:grid-cols-3 gap-6">

        <div class="border border-white/10 rounded-xl p-6">
          <p class="text-sm text-[#7D8895]">Total Capital</p>
          <p id="totalCapital" class="text-2xl font-bold">RM 0</p>
        </div>

        <div class="border border-white/10 rounded-xl p-6">
          <p class="text-sm text-[#7D8895]">Current Balance</p>
          <p id="currentBalance" class="text-2xl font-bold">RM 0</p>
        </div>

        <div class="border border-white/10 rounded-xl p-6">
          <p class="text-sm text-[#7D8895]">Net Trading Profit</p>
          <p id="netProfit" class="text-2xl font-bold text-green-400">RM 0</p>
        </div>

      </div>

      <p class="text-xs text-[#7D8895]">
        All values are calculated automatically based on approved deposits and admin profit updates (prototype).
      </p>

    </main>
  </div>

</div>

<!-- SIDEBAR -->
<script>
fetch("partials/sidebar.html")
  .then(r => r.text())
  .then(h => document.getElementById("sidebar").innerHTML = h);
</script>

<!-- LOGIC -->
<script>
/* AUTH GUARD */
const currentUser = JSON.parse(localStorage.getItem("currentUser"));
if (!currentUser || currentUser.role !== "user") {
  location.href = "../login.html";
}

document.getElementById("userName").innerText = currentUser.name;

/* DATA */
const transactions = JSON.parse(localStorage.getItem("transactions")) || [];
const dailyProfit = JSON.parse(localStorage.getItem("daily_profit")) || [];

/* TOTAL CAPITAL (approved deposit sahaja) */
const totalCapital = transactions
  .filter(t => t.type === "deposit" && t.status === "approved" && t.userId === currentUser.id)
  .reduce((sum, t) => sum + t.amount, 0);

/* PROFIT KASAR */
const grossProfit = dailyProfit
  .filter(p => p.userId === currentUser.id)
  .reduce((sum, p) => sum + p.profit, 0);

/* PROFIT SPLIT */
let userPercent = 0.8;
if (totalCapital >= 5000 && totalCapital < 10000) userPercent = 0.85;
if (totalCapital >= 10000) userPercent = 0.9;

const netProfit = Math.round(grossProfit * userPercent);
const currentBalance = totalCapital + netProfit;

/* RENDER */
document.getElementById("totalCapital").innerText =
  `RM ${totalCapital.toLocaleString()}`;

document.getElementById("netProfit").innerText =
  `RM ${netProfit.toLocaleString()}`;

document.getElementById("currentBalance").innerText =
  `RM ${currentBalance.toLocaleString()}`;
</script>

</body>
</html>
